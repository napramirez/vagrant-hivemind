Vagrant.configure(2) do |config|
  config.vm.define "<%= host.hostname %>" do |host_config|
    host_config.vm.box = "<%= box_types[host.box_type.to_sym][:box_id] %>"
    host_config.vm.network "private_network", ip: "<%= host.ip_address %>", virtualbox__intnet: true

    host_config.vm.provider "virtualbox" do |vb|
      vb.memory = "<%= box_sizes[host.box_size.to_sym][:memory_in_mb] %>".to_i
      vb.gui = "<%= box_types[host.box_type.to_sym][:is_gui] %>" == "true"
    end

    host_config.vm.synced_folder "<%= cache_dir %>/cache/apt", "/var/cache/apt/archives", create: true
    host_config.vm.provision "shell" do |s|
      s.path = "<%= hivemind_home_dir %>/scripts/setup-hostname.sh"
      s.args = ["<%= host.hostname %>"]
    end

    if "<%= host.is_control %>" == "true"
      # Setup Control Machine SSH
      # 1. Copy the private key
      host_config.vm.provision "file", source: "<%= hivemind_home_dir %>/keys/id_rsa", destination: "/home/vagrant/.ssh/"

      # 2. Set the right permissions of the SSH directory and private key
      host_config.vm.provision "shell", path: "<%= hivemind_home_dir %>/scripts/setup-control-ssh.sh"

      host_config.vm.provision "shell", path: "<%= hivemind_home_dir %>/scripts/install-ansible.sh"
      host_config.vm.provision "shell", path: "<%= hivemind_home_dir %>/scripts/post-install-ansible.sh"
    end

    host_config.vm.provision "shell", path: "<%= hivemind_home_dir %>/scripts/setup-drone-ssh.sh"
    host_config.vm.provision "shell", path: "<%= hivemind_home_dir %>/scripts/update-system-hosts.sh"
  end
end
